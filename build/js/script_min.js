var app=angular.module("app",["ui.router"]);app.constant("baseUrl","http://dtapi.local/"),app.config(function(t,e){t.state("login",{url:"/",templateUrl:"app/views/login.html",controller:"loginCtrl"}).state("admin",{url:"/admin",templateUrl:"app/views/admin.html"}).state("admin.main",{url:"/main",templateUrl:"app/views/main.html"}).state("user",{url:"/user",templateUrl:"app/views/user.html"}).state("admin.educationInfo",{url:"/educationInfo",templateUrl:"app/views/educationInfo.html"}).state("admin.educationInfo.groups",{url:"/groups",templateUrl:"app/views/groupList.html",controller:"groupsCtrl"}).state("admin.educationInfo.faculties",{url:"/faculties",templateUrl:"app/views/facultyList.html",controller:"entitiesCtrl"}).state("admin.educationInfo.specialities",{url:"/specialities",templateUrl:"app/views/specialitiesList.html",controller:"entitiesCtrl"}).state("admin.subjects",{url:"/subjects",templateUrl:"app/views/subjectsList.html",controller:"entitiesCtrl"}).state("admin.tests",{url:"/tests/:id",templateUrl:"app/views/testsList.html",controller:"entitiesCtrl"}).state("admin.students",{url:"/students",templateUrl:"app/views/getStudents.html",controller:"getStudentsCtrl"}).state("admin.addStudent",{url:"/students/addStudent",templateUrl:"app/views/addStudentRecord.html",controller:"addStudentCtrl"}).state("admin.addAdmin",{url:"/addAdmin",templateUrl:"app/views/addAdmin.html",controller:"addAdminCtrl"}),e.otherwise("/")}),app.controller("addAdminCtrl",function(t,e){function n(){e.getEntities(t.thisEntity).then(function(e){t.admins=e.data,t.noData="Not found",console.log(t.admins)})}t.thisEntity="AdminUser",t.showAddForm=function(){t.showingAdd?(t.showingAdd=!1,t.newUsername="",t.newEmail=""):t.showingAdd=!0},t.addAdmin=function(){var n={username:t.newUsername,password:t.newPassword,password_confirm:t.newPasswordConfirm,email:t.newEmail};e.createEntity(t.thisEntity,n).then(function(e){"ok"==e.data.response?(n.admin_id=e.data.id,t.admins.push(n)):alert("������� "+e.data.response)}),t.showAddForm()},t.showEditForm=function(e){t.editingAdmin!=e?(t.editingAdmin=e,t.editingData={},t.editingData.editingUsername=e.username,t.editingData.editingPassword="",t.editingData.editingPasswordConfirm="",t.editingData.editingEmail=e.email,t.currentId=e.id):t.editingAdmin=null},t.editAdmin=function(){var n={username:t.editingData.editingUsername,password:t.editingData.editingPassword,password_confirm:t.editingData.editingPasswordConfirm,email:t.editingData.editingEmail};e.updateEntity(t.thisEntity,t.currentId,n).then(function(e){if("ok"==e.data.response)for(var i=1;i<t.admins.length;i++)t.admins[i].id==t.currentId&&(t.admins[i].username=n.username,t.admins[i].password=n.password,t.admins[i].password_confirm=n.password_confirm,t.admins[i].email=n.email);else alert("������� "+e.data.response)}),t.editingAdmin=null},t.activateAdmin=function(e){t.activeAdmin!=e?t.activeAdmin=e:t.activeAdmin=null},t.removeAdmin=function(){var n=t.activeAdmin,i=t.activeAdmin.id;e.deleteEntity(t.thisEntity,i).then(function(e){if("ok"==e.data.response){var i=t.admins.indexOf(n);t.admins.splice(i,1)}else alert("������� "+e.data.response)}),t.activateAdmin()},n()}),angular.module("app").controller("addStudentCtrl",["$scope","addStudentSrvc",function(t,e){t.getError=function(t){if(angular.isDefined(t)){if(t.required)return"Please, fill in this field";if(t.minlength)return"Your information is too short. Please, fill in more information.";if(t.maxlength)return"There are to much symbols. Please, try to be more laconical.";if(t.email)return"Please, enter valid email address"}},t.addNewStudent=function(t){t.group_id||(t.group_id="3"),t.photo||(t.photo=" ");var n={username:t.username,password:t.password,password_confirm:t.password_confirm,email:t.email,gradebook_id:t.gradebook_id,student_surname:t.student_surname,student_name:t.student_name,student_fname:t.student_fname,group_id:t.group_id,plain_password:t.password_confirm,photo:t.photo};e.addStudent(n)}}]),app.controller("entitiesCtrl",function(t,e,n,i){function a(e){t.infMsg=e,angular.element(document.querySelector("#informModal")).modal()}t.thisEntity="";var r={faculty:{faculty_name:"",faculty_description:""},speciality:{speciality_name:"",speciality_code:""},subject:{subject_name:"",subject_description:""},test:{test_name:"",tasks:"",time_for_test:"",enabled:"",attempts:"",by:{parentEntity:"subject"}}};for(ent in r)ent==t.thisEntity&&(t.currentEntity=r[ent],console.log(t.currentEntity));t.getEntetyList=function(){for(ent in r)ent==t.thisEntity&&(t.currentEntity=r[ent]);if(t.currentEntity.by){var i=n.id;e.getEntitiesByEntity(t.thisEntity,t.currentEntity.by.parentEntity,i).then(function(e){t.entities=e.data,t.noData="Немає записів"})}else e.getEntities(t.thisEntity).then(function(e){t.entities=e.data,t.noData="Немає записів"})},t.showAddForm=function(){t.showingAdd?(t.showingAdd=!1,t.newEntity=t.currentEntity):t.showingAdd=!0},t.addEntity=function(){if(t.currentEntity.by){var i=t.newEntity;i[t.currentEntity.by.parentEntity+"_id"]=n.id}else var i=t.newEntity;e.createEntity(t.thisEntity,i).then(function(e){switch(e.data.response){case"ok":i[t.thisEntity+"_id"]=e.data.id,t.entities.push(i);break;case"error 23000":a("Зазначене ім'я вже існує");break;default:a("Помилка редагування запису: "+e.data.response)}}),t.showAddForm()},t.showEditForm=function(e){if(t.editingEntity!=e){t.editingEntity=e,t.editedEntity={};for(prop in e)t.editedEntity["new_"+prop]=e[prop]}else t.editingEntity=null},t.editEntity=function(n){var i,r={};for(prop in n)if(""!=t.editedEntity["new_"+prop]&&prop!=t.thisEntity+"_id")i=!0,r[prop]=t.editedEntity["new_"+prop];else{if(""==t.editedEntity["new_"+prop]){i=!1;break}i=!0}1==i?e.updateEntity(t.thisEntity,n[t.thisEntity+"_id"],r).then(function(e){switch(e.data.response){case"ok":for(var i=1;i<t.entities.length;i++)if(t.entities[i][t.thisEntity+"_id"]==n[t.thisEntity+"_id"])for(prop in r)t.entities[i][prop]=r[prop];t.editingEntity=null;break;case"error 23000":a("Зазначене ім'я вже існує");break;default:a("Помилка редагування запису: "+e.data.response)}}):a("Будь ласка, заповніть всі поля")},t.activateEntity=function(e){t.deletingEntity!=e?t.deletingEntity=e:t.deletingEntity=null},t.removeEntity=function(){var n=t.deletingEntity,i=t.deletingEntity[t.thisEntity+"_id"];e.deleteEntity(t.thisEntity,i).then(function(e){switch(e.data.response){case"ok":var i=t.entities.indexOf(n);t.entities.splice(i,1);break;case"error 23000":a("Неможливо видалити запис. Запис має залежні об'єкти.");break;default:a("Помилка редагування запису: "+e.data.response)}}),t.activateEntity()}}),angular.module("app").controller("getStudentsCtrl",["$scope","entitiesSrvc",function(t,e){t.thisEntity="student",e.getEntities(t.thisEntity).then(function(e){t.students=e,t.noData="There is no entities here."}),t.showEditingForm=function(e){console.log(e),null!==e&&(t.currId=e.user_id),t.editingStudent=e},t.editStud=function(){var n={user_id:t.editingStudent.user_id,gradebook_id:t.editingStudent.gradebook_id,student_surname:t.editingStudent.student_surname,student_name:t.editingStudent.student_name,student_fname:t.editingStudent.student_fname,group_id:t.editingStudent.group_id,photo:""},i=t.editingStudent;console.log(i);var a=t.currId;e.updateEntity(t.thisEntity,a,n).then(function(e){if("ok"!=e.data.response)throw new Error('Server response was not "OK" - '+e.data.response);for(var n=1;n<t.students.list.length;n++)if(t.students.list[n].user_id!=a)throw new Error(t.students.list[n]+" is different from "+a+" id.. Try to solve this or, please, contact with your back-end administrator.")}),t.editingStudent=null,t.currId=null},t.confirmDelete=function(e){t.confirmedStud!=e?t.confirmedStud=e:t.confirmedStud=null},t.deleteStudent=function(){var n=t.confirmedStud,i=t.confirmedStud;e.deleteEntity(t.thisEntity,n).then(function(e){if("ok"==e.data.response){var n=t.students.list.indexOf(i);t.students.list.splice(n,1)}else alert("Error "+e.data.response)}),t.confirmDelete()}}]),app.controller("groupsCtrl",function(t,e){t.thisEntity="group",e.getEntities(t.thisEntity).then(function(e){t.groups=e}),t.showAddForm=function(){t.showingAdd?(t.showingAdd=!1,t.newDescription="",t.newName=""):t.showingAdd=!0},t.addGroup=function(){var n={speciality_id:t.newSpeciality_id,faculty_id:t.newFaculty_id,group_name:t.newName},i={speciality_id:t.newSpeciality_id,faculty_id:t.newFaculty_id,group_name:t.newName,speciality_name:t.groups.speciality[t.newSpeciality_id],faculty_name:t.groups.faculty[t.newFaculty_id]};e.createEntity(t.thisEntity,n).then(function(e){"ok"==e.data.response?(i.group_id=e.data.id,t.groups.list.push(i)):alert("Помилка "+e.data.response)}),t.showAddForm()},t.showEditForm=function(e){null!==e&&(t.currentId=e.group_id),t.editingData=e},t.editGroup=function(){var n={speciality_id:t.editingData.speciality_id,faculty_id:t.editingData.faculty_id,group_name:t.editingData.group_name},i=t.editingData;i.faculty_name=t.groups.faculty[i.faculty_id],i.speciality_name=t.groups.speciality[i.speciality_id];var a=t.currentId;e.updateEntity(t.thisEntity,a,n).then(function(e){if("ok"==e.data.response)for(var n=1;n<t.groups.list.length;n++)t.groups.list[n].group_id==a&&(t.groups.list[n]=i);else alert("Помилка "+e.data.response)}),t.editingData=null,t.currentId=null},t.activateGroup=function(e){t.activeGroup!=e?t.activeGroup=e:t.activeGroup=null},t.removeGroup=function(){var n=t.activeGroup,i=t.activeGroup;console.log(n),e.deleteEntity(t.thisEntity,i).then(function(e){if("ok"==e.data.response){var i=t.groups.list.indexOf(n);t.groups.list.splice(i,1)}else alert("Помилка "+e.data.response)}),t.activateGroup()}}),app.controller("loginCtrl",function(t,e,n,i){t.getError=function(t){if(angular.isDefined(t)){if(t.required)return"Field can't be empty!";if(t.minlength)return"No less than 4 characters!"}},t.enter=function(){t.wrongCredentials=!1;var n={username:t.username,password:t.password};i.enterLogin(n).then(function(n){"ok"===n.data.response&&"admin"===n.data.roles[1]?(localStorage.adminName=n.data.username,localStorage.adminId=n.data.id,e.go("admin.main")):"ok"===n.data.response&&"student"===n.data.roles[1]?(localStorage.userName=n.data.username,localStorage.userId=n.data.id,e.go("user")):t.wrongCredentials=!0})},t.exit=function(){i.logOut().then()}}),app.directive("entitiesDrct",function(t){return{link:function(t,e,n){t.thisEntity=n.entitiesDrct,t.getEntetyList()},restrict:"A"}}),angular.module("app").factory("addStudentSrvc",["$http",function(t){var e="http://dtapi.local/",n={};return n.addStudent=function(n){function i(t){var e=t.data.response;return e}function a(t){var e=t.data.response;return e}var r=JSON.stringify(n);return t.post(e+"student/insertData",r).then(i,a)},n}]),app.factory("authSrvc",function(t,e,n){function i(t){return t}function a(t){return t}var r=function(){e.go("login")};return{enterLogin:function(e){return t.post(n+"login/index",e).then(i,a)},logOut:function(){return t.get(n+"login/logout").then(function(){return r()},function(){return r()})}}}),app.factory("entitiesSrvc",function(t,e){function n(t){return t}function i(t){alert("Помилка "+t.status+" "+t.statusText)}var a={group:"speciality,faculty",student:"group"},r=function(n,i){var a=i+"_id",r=i+"_name";return t.get(e+i+"/getRecords").then(function(t){var e=t.data,o=[],s={};for(row in e)o[+e[row][a]]=e[row][r],s[e[row][a]]=e[row][r];n[i]=s;for(row in n.list){var d=parseInt(n.list[row][a]);n.list[row][r]=o[d]}return n},function(){console.error("Error")})};return{getEntitiesByEntity:function(a,r,o){return t.get(e+a+"/get"+a[0].toUpperCase()+a.slice(1)+"sBy"+r[0].toUpperCase()+r.slice(1)+"/"+o).then(n,i)},getEntities:function(n){return t.get(e+n+"/getRecords").then(function(t){if(void 0!=a[n]){var e=a[n].split(",");data={},data.list=t.data;for(depId in e){if(depId==e.length-1)return r(data,e[depId]);r(data,e[depId])}}return t},i)},createEntity:function(a,r){return t.post(e+a+"/insertData",r).then(n,i)},deleteEntity:function(a,r){return t["delete"](e+a+"/del/"+r).then(n,i)},updateEntity:function(a,r,o){return t.post(e+a+"/update/"+r,o).then(n,i)}}});