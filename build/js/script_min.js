var app=angular.module("app",["ui.router"]);app.constant("baseUrl","http://dtapi.local/"),app.config(function(t,e){t.state("login",{url:"/",templateUrl:"app/views/login.html",controller:"loginCtrl"}).state("admin",{url:"/admin",templateUrl:"app/views/admin.html"}).state("user",{url:"/user",templateUrl:"app/views/user.html"}).state("admin.educationInfo",{url:"/educationInfo",templateUrl:"app/views/educationInfo.html"}).state("admin.educationInfo.groups",{url:"/groups",templateUrl:"app/views/groupList.html",controller:"groupsCtrl"}).state("admin.educationInfo.faculties",{url:"/faculties",templateUrl:"app/views/facultyList.html",controller:"facultiesCtrl"}).state("admin.educationInfo.specialities",{url:"/specialities",templateUrl:"app/views/specialitiesList.html",controller:"specialitiesCtrl"}).state("admin.subjects",{url:"/subjects",templateUrl:"app/views/subjectsList.html",controller:"subjectsCtrl"}).state("admin.students",{url:"/students",templateUrl:"app/views/getStudents.html",controller:"getStudentsCtrl"}).state("admin.addStudent",{url:"/students/addStudent",templateUrl:"app/views/addStudentRecord.html",controller:"addStudentCtrl"}),e.otherwise("/")}),angular.module("app").factory("addStudentSrvc",["$http",function(t){var e="http://dtapi.local/",i={};return i.addStudent=function(i){function n(t){var e=t.data.response;return e}function a(t){var e=t.data.response;return e}var r=JSON.stringify(i);return t.post(e+"student/insertData",r).then(n,a)},i}]),app.factory("authSrvc",function(t,e){function i(t){return t}function n(t){return t}var a="http://dtapi.local/",r=function(){console.log("toAuth!!!!!!!!!!!!!!"),e.go("login")};return{enterLogin:function(e){return t.post(a+"login/index",e).then(i,n)},logOut:function(){return t.get(a+"login/logout").then(function(){return console.log("logout1!!!!!!!!!!!!"),r()},function(){return console.log("logout2!!!!!!!!!!!!!!!!"),r()})}}}),app.factory("entitiesSrvc",function(t,e){function i(t){return t}function n(t){alert("Помилка "+t.status+" "+t.statusText)}var a={group:"speciality,faculty",student:"group"},r=function(i,n){var a=n+"_id",r=n+"_name";return t.get(e+n+"/getRecords").then(function(t){var e=t.data,o=[],s={};for(row in e)o[+e[row][a]]=e[row][r],s[e[row][a]]=e[row][r];i[n]=s;for(row in i.list){var d=parseInt(i.list[row][a]);i.list[row][r]=o[d]}return i},function(){console.error("Error")})};return{getEntities:function(i){return t.get(e+i+"/getRecords").then(function(t){if(void 0!=a[i]){var e=a[i].split(",");data={},data.list=t.data;for(depId in e){if(depId==e.length-1)return r(data,e[depId]);r(data,e[depId])}}return t},n)},createEntity:function(a,r){return t.post(e+a+"/insertData",r).then(i,n)},deleteEntity:function(a,r){return t["delete"](e+a+"/del/"+r).then(i,n)},updateEntity:function(a,r,o){return t.post(e+a+"/update/"+r,o).then(i,n)}}}),angular.module("app").controller("addStudentCtrl",["$scope","addStudentSrvc",function(t,e){t.getError=function(t){if(angular.isDefined(t)){if(t.required)return"Please, fill in this field";if(t.minlength)return"Your information is too short. Please, fill in more information.";if(t.maxlength)return"There are to much symbols. Please, try to be more laconical.";if(t.email)return"Please, enter valid email address"}},t.addNewStudent=function(t){t.group_id||(t.group_id="3"),t.photo||(t.photo=" ");var i={username:t.username,password:t.password,password_confirm:t.password_confirm,email:t.email,gradebook_id:t.gradebook_id,student_surname:t.student_surname,student_name:t.student_name,student_fname:t.student_fname,group_id:t.group_id,plain_password:t.password_confirm,photo:t.photo};e.addStudent(i)}}]),app.controller("facultiesCtrl",function(t,e){function i(){e.getEntities(t.thisEntity).then(function(e){t.faculties=e.data,t.noData="Немає записів"})}t.thisEntity="faculty",t.showAddForm=function(){t.showingAdd?(t.showingAdd=!1,t.newDescription="",t.newName=""):t.showingAdd=!0},t.addFaculty=function(){var i={faculty_description:t.newDescription,faculty_name:t.newName};e.createEntity(t.thisEntity,i).then(function(e){"ok"==e.data.response?(i.faculty_id=e.data.id,t.faculties.push(i)):alert("Помилка "+e.data.response)}),t.showAddForm()},t.showEditForm=function(e){t.editingFaculty!=e?(t.editingFaculty=e,t.editingData={},t.editingData.editingDescription=e.faculty_description,t.editingData.editingName=e.faculty_name,t.currentId=e.faculty_id):t.editingFaculty=null},t.editFaculty=function(){var i={faculty_description:t.editingData.editingDescription,faculty_name:t.editingData.editingName};e.updateEntity(t.thisEntity,t.currentId,i).then(function(e){if("ok"==e.data.response)for(var n=1;n<t.faculties.length;n++)t.faculties[n].faculty_id==t.currentId&&(t.faculties[n].faculty_description=i.faculty_description,t.faculties[n].faculty_name=i.faculty_name);else alert("Помилка "+e.data.response)}),t.editingFaculty=null},t.activateFaculty=function(e){t.activeFaculty!=e?t.activeFaculty=e:t.activeFaculty=null},t.removeFaculty=function(){var i=t.activeFaculty,n=t.activeFaculty.faculty_id;e.deleteEntity(t.thisEntity,n).then(function(e){if("ok"==e.data.response){var n=t.faculties.indexOf(i);t.faculties.splice(n,1)}else alert("Помилка "+e.data.response)}),t.activateFaculty()},i()}),angular.module("app").controller("getStudentsCtrl",["$scope","entitiesSrvc",function(t,e){t.thisEntity="student",e.getEntities(t.thisEntity).then(function(e){t.students=e,t.noData="There is no entities here."}),t.showEditingForm=function(e){console.log(e),null!==e&&(t.currId=e.user_id),t.editingStudent=e},t.editStud=function(){var i={user_id:t.editingStudent.user_id,gradebook_id:t.editingStudent.gradebook_id,student_surname:t.editingStudent.student_surname,student_name:t.editingStudent.student_name,student_fname:t.editingStudent.student_fname,group_id:t.editingStudent.group_id,photo:""},n=t.editingStudent;console.log(n);var a=t.currId;e.updateEntity(t.thisEntity,a,i).then(function(e){if("ok"!=e.data.response)throw new Error('Server response was not "OK" - '+e.data.response);for(var i=1;i<t.students.list.length;i++)if(t.students.list[i].user_id!=a)throw new Error(t.students.list[i]+" is different from "+a+" id.. Try to solve this or, please, contact with your back-end administrator.")}),t.editingStudent=null,t.currId=null},t.confirmDelete=function(e){t.confirmedStud!=e?t.confirmedStud=e:t.confirmedStud=null},t.deleteStudent=function(){var i=t.confirmedStud,n=t.confirmedStud;e.deleteEntity(t.thisEntity,i).then(function(e){if("ok"==e.data.response){var i=t.students.list.indexOf(n);t.students.list.splice(i,1)}else alert("Error "+e.data.response)}),t.confirmDelete()}}]),app.controller("groupsCtrl",function(t,e){t.thisEntity="group",e.getEntities(t.thisEntity).then(function(e){t.groups=e}),t.showAddForm=function(){t.showingAdd?(t.showingAdd=!1,t.newDescription="",t.newName=""):t.showingAdd=!0},t.addGroup=function(){var i={speciality_id:t.newSpeciality_id,faculty_id:t.newFaculty_id,group_name:t.newName},n={speciality_id:t.newSpeciality_id,faculty_id:t.newFaculty_id,group_name:t.newName,speciality_name:t.groups.speciality[t.newSpeciality_id],faculty_name:t.groups.faculty[t.newFaculty_id]};e.createEntity(t.thisEntity,i).then(function(e){"ok"==e.data.response?(n.group_id=e.data.id,t.groups.list.push(n)):alert("Помилка "+e.data.response)}),t.showAddForm()},t.showEditForm=function(e){null!==e&&(t.currentId=e.group_id),t.editingData=e},t.editGroup=function(){var i={speciality_id:t.editingData.speciality_id,faculty_id:t.editingData.faculty_id,group_name:t.editingData.group_name},n=t.editingData;n.faculty_name=t.groups.faculty[n.faculty_id],n.speciality_name=t.groups.speciality[n.speciality_id];var a=t.currentId;e.updateEntity(t.thisEntity,a,i).then(function(e){if("ok"==e.data.response)for(var i=1;i<t.groups.list.length;i++)t.groups.list[i].group_id==a&&(t.groups.list[i]=n);else alert("Помилка "+e.data.response)}),t.editingData=null,t.currentId=null},t.activateGroup=function(e){t.activeGroup!=e?t.activeGroup=e:t.activeGroup=null},t.removeGroup=function(){var i=t.activeGroup,n=t.activeGroup;console.log(i),e.deleteEntity(t.thisEntity,n).then(function(e){if("ok"==e.data.response){var n=t.groups.list.indexOf(i);t.groups.list.splice(n,1)}else alert("Помилка "+e.data.response)}),t.activateGroup()}}),app.controller("loginCtrl",function(t,e,i,n){t.getError=function(t){if(angular.isDefined(t)){if(t.required)return"Field can't be empty!";if(t.minlength)return"No less than 4 characters!"}},t.enter=function(){t.wrongCredentials=!1;var i={username:t.username,password:t.password};n.enterLogin(i).then(function(i){"ok"===i.data.response&&"admin"===i.data.roles[1]?(localStorage.adminName=i.data.username,localStorage.adminId=i.data.id,e.go("admin")):"ok"===i.data.response&&"student"===i.data.roles[1]?(localStorage.userName=i.data.username,localStorage.userId=i.data.id,e.go("user")):(console.log("wrong credentials"),t.wrongCredentials=!0)})},t.exit=function(){n.logOut().then(),console.log("exit!!!!!!!!")}}),app.controller("specialitiesCtrl",function(t,e){function i(){e.getEntities(t.thisEntity).then(function(e){t.specialities=e.data,t.noData="Немає записів"})}t.thisEntity="speciality",t.showAddForm=function(){t.showingAdd?(t.showingAdd=!1,t.newCode="",t.newName=""):t.showingAdd=!0},t.addSpeciality=function(){var i={speciality_code:t.newCode,speciality_name:t.newName};e.createEntity(t.thisEntity,i).then(function(e){"ok"==e.data.response?(i.speciality_id=e.data.id,t.specialities.push(i)):alert("Помилка "+e.data.response)}),t.showAddForm()},t.showEditForm=function(e){t.editingSpeciality!=e?(t.editingSpeciality=e,t.editingData={},t.editingData.editingCode=e.speciality_code,t.editingData.editingName=e.speciality_name,t.currentId=e.speciality_id):t.editingSpeciality=null},t.editSpeciality=function(){var i={speciality_code:t.editingData.editingCode,speciality_name:t.editingData.editingName};e.updateEntity(t.thisEntity,t.currentId,i).then(function(e){if("ok"==e.data.response)for(var n=1;n<t.specialities.length;n++)t.specialities[n].speciality_id==t.currentId&&(t.specialities[n].speciality_code=i.speciality_code,t.specialities[n].speciality_name=i.speciality_name);else alert("Помилка "+e.data.response)}),t.editingSpeciality=null},t.activateSpeciality=function(e){t.activeSpeciality!=e?t.activeSpeciality=e:t.activeSpeciality=null},t.removeSpeciality=function(){var i=t.activeSpeciality,n=t.activeSpeciality.speciality_id;e.deleteEntity(t.thisEntity,n).then(function(e){if("ok"==e.data.response){var n=t.specialities.indexOf(i);t.specialities.splice(n,1)}else alert("Помилка "+e.data.response)}),t.activateSpeciality()},i()}),app.controller("subjectsCtrl",function(t,e){function i(){e.getEntities(t.thisEntity).then(function(e){t.subjects=e.data,t.noData="Немає записів"})}t.thisEntity="subject",t.showAddForm=function(){t.showingAdd?(t.showingAdd=!1,t.newDescription="",t.newName=""):t.showingAdd=!0},t.addSubject=function(){var i={subject_description:t.newDescription,subject_name:t.newName};e.createEntity(t.thisEntity,i).then(function(e){"ok"==e.data.response?(i.subject_id=e.data.id,t.subjects.push(i)):alert("Помилка "+e.data.response)}),t.showAddForm()},t.showEditForm=function(e){t.editingSubject!=e?(t.editingSubject=e,t.editingData={},t.editingData.editingDescription=e.subject_description,t.editingData.editingName=e.subject_name,t.currentId=e.subject_id):t.editingSubject=null},t.editSubject=function(){var i={subject_description:t.editingData.editingDescription,subject_name:t.editingData.editingName};e.updateEntity(t.thisEntity,t.currentId,i).then(function(e){if("ok"==e.data.response)for(var n=1;n<t.subjects.length;n++)t.subjects[n].subject_id==t.currentId&&(t.subjects[n].subject_description=i.subject_description,t.subjects[n].subject_name=i.subject_name);else alert("Помилка "+e.data.response)}),t.editingSubject=null},t.activateSubject=function(e){t.activeSubject!=e?t.activeSubject=e:t.activeSubject=null},t.removeSubject=function(){var i=t.activeSubject,n=t.activeSubject.subject_id;e.deleteEntity(t.thisEntity,n).then(function(e){if("ok"==e.data.response){var n=t.subjects.indexOf(i);t.subjects.splice(n,1)}else alert("Помилка "+e.data.response)}),t.activateSubject()},i()});